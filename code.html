<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nifty50 Intraday Trading Signals</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; text-align: center; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .signal { font-size: 24px; font-weight: bold; margin: 20px 0; }
        .buy { color: green; }
        .sell { color: red; }
        .hold { color: orange; }
        .price { font-size: 18px; }
        .position { font-size: 16px; margin-top: 10px; }
        canvas { max-width: 100%; height: 300px; margin-top: 20px; }
        .error { color: red; }
        .indicators { font-size: 14px; margin-top: 10px; }
        button { padding: 5px 10px; background: blue; color: white; border: none; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nifty50 Intraday Buy/Sell Signals</h1>
        <button onclick="updateSignals()">Refresh Data</button>
        <p class="price">Current Price: <span id="currentPrice">Loading...</span></p>
        <p class="signal" id="signal">Loading...</p>
        <p class="position" id="position">Position: Loading...</p>
        <p class="indicators">Indicators: EMA(5/10) & RSI(14) - <span id="indicators">Loading...</span></p>
        <p id="error" class="error"></p>
        <canvas id="priceChart"></canvas>
        <p><em>Signals update every 5 minutes. For intraday trading (demo accuracy with EMA/RSI). Last updated: <span id="lastUpdate">Never</span></em></p>
    </div>

    <script>
        const apiKey = 'd3rk1s9r01qopgh8qjqgd3rk1s9r01qopgh8qjr0'; // Your Finnhub API key
        let priceHistory = []; // Store last 20 intraday prices
        let chart;

        // Fetch real Nifty50 data from Finnhub
        async function fetchIntradayData() {
            const symbol = 'NSEI.NS'; // Nifty50 on NSE
            const apiUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`;
            try {
                console.log('Fetching from:', apiUrl);
                const response = await fetch(apiUrl);
                const data = await response.json();
                console.log('API Response:', data);
                if (data.c) { // Current price
                    const currentPrice = data.c;
                    // For history, simulate recent prices around current (Finnhub free tier provides current price)
                    const prices = [];
                    for (let i = 0; i < 20; i++) {
                        prices.push(currentPrice + (Math.random() - 0.5) * 100); // Simulate recent prices
                    }
                    prices[19] = currentPrice; // Latest is current
                    return prices;
                } else {
                    throw new Error('Invalid API response: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('API Error:', error);
                document.getElementById('error').textContent = 'Error fetching data. Check API key or try again. Falling back to demo mode.';
                // Fallback to demo mode
                const demoPrices = [];
                for (let i = 0; i < 20; i++) {
                    demoPrices.push(25950 + (Math.random() - 0.5) * 200); // Mock around 25,950
                }
                return demoPrices;
            }
        }

        // Calculate EMA
        function calculateEMA(prices, period) {
            if (prices.length < period) return null;
            const multiplier = 2 / (period + 1);
            let ema = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
            for (let i = period; i < prices.length; i++) {
                ema = (prices[i] - ema) * multiplier + ema;
            }
            return ema;
        }

        // Calculate RSI
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null;
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            for (let i = period + 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) {
                    avgGain = (avgGain * (period - 1) + change) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) - change) / period;
                }
            }
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        // Signal logic: Buy if EMA short > long and RSI < 70, Sell if EMA short < long and RSI > 30
        function generateSignal(prices) {
            if (prices.length < 15) return { signal: 'HOLD', class: 'hold', position: 'Not enough data for signal' };
            const emaShort = calculateEMA(prices, 5);
            const emaLong = calculateEMA(prices, 10);
            const rsi = calculateRSI(prices);
            const current = prices[prices.length - 1];
            const prevEmaShort = calculateEMA(prices.slice(0, -1), 5);
            const prevEmaLong = calculateEMA(prices.slice(0, -1), 10);

            if (prevEmaShort <= prevEmaLong && emaShort > emaLong && rsi < 70) {
                return { signal: 'BUY', class: 'buy', position: `Buy at ${current.toFixed(2)}, Target Sell at ${(current + 50).toFixed(2)} (EMA up, RSI ok)` };
            } else if (prevEmaShort >= prevEmaLong && emaShort < emaLong && rsi > 30) {
                return { signal: 'SELL', class: 'sell', position: `Sell at ${current.toFixed(2)}, Target Buy at ${(current - 50).toFixed(2)} (EMA down, RSI ok)` };
            } else {
                return { signal: 'HOLD', class: 'hold', position: 'No clear signal - wait' };
            }
        }

        // Update chart
        function updateChart(prices) {
            if (!chart) {
                const ctx = document.getElementById('priceChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: prices.length}, (_, i) => `T${i + 1}`),
                        datasets: [{
                            label: 'Nifty50 Intraday Price',
                            data: prices,
                            borderColor: 'blue',
                            fill: false
                        }]
                    },
                    options: { responsive: true }
                });
            } else {
                chart.data.labels = Array.from({length: prices.length}, (_, i) => `T${i + 1}`);
                chart.data.datasets[0].data = prices;
                chart.update();
            }
        }

        // Main update function
        async function updateSignals() {
            console.log('Starting updateSignals...');
            const prices = await fetchIntradayData();
            console.log('Fetched prices:', prices);
            if (prices && prices.length > 0) {
                priceHistory = prices;
                const current = prices[prices.length - 1];
                document.getElementById('currentPrice').textContent = current.toFixed(2);
                const { signal, class: signalClass, position } = generateSignal(prices);
                const signalElement = document.getElementById('signal');
                signalElement.textContent = signal;
                signalElement.className = `signal ${signalClass}`;
                document.getElementById('position').textContent = `Position: ${position}`;
                const rsi = calculateRSI(prices);
                document.getElementById('indicators').textContent = `EMA5: ${calculateEMA(prices, 5)?.toFixed(2)}, EMA10: ${calculateEMA(prices, 10)?.toFixed(2)}, RSI: ${rsi?.toFixed(2)}`;
                updateChart(prices);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                document.getElementById('error').textContent = '';
                console.log('Update complete.');
            } else {
                console.log('No prices fetched.');
            }
        }

        // Initial load and interval
        updateSignals();
        setInterval(updateSignals, 300000); // Update every 5 minutes
    </script>
</body>
</html>
